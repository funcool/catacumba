<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="author" content="Andrey Antukh, &lt;niwi@niwi.nz&gt;">
<title>Catacumba - Web toolkit for Clojure.</title>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f0f0f0; }
.listingblock .pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #007020 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #902000 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #40a070 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #4070a0 } /* Literal.String */
.listingblock .pygments .tok-na { color: #4070a0 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #007020 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #60add5 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #007020 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06287e } /* Name.Function */
.listingblock .pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Liberation+Mono:400|Roboto+Slab:400,700"/>
<link rel="stylesheet" href="https://www.niwi.nz/_assets/asciidoctor-styles/simple-red-titles/stylesheet.css"/>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Catacumba - Web toolkit for Clojure.</h1>
<div class="details">
<span id="author" class="author">Andrey Antukh, &lt;niwi@niwi.nz&gt;</span><br>
<span id="revnumber">version 0.17.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#quickstart">Quick Start</a>
<ul class="sectlevel2">
<li><a href="#install">Install</a></li>
<li><a href="#handlers">Handlers</a></li>
<li><a href="#quick-start-routing">Routing</a></li>
<li><a href="#run-the-server">Run the server</a></li>
<li><a href="#put-all-together">Put all together</a></li>
</ul>
</li>
<li><a href="#user-guide">User Guide</a>
<ul class="sectlevel2">
<li><a href="#handlers-2">Handlers</a></li>
<li><a href="#context">Context</a></li>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#routing">Routing</a></li>
</ul>
</li>
<li><a href="#advanced-topics">Advanced topics</a>
<ul class="sectlevel2">
<li><a href="#handler-delegation">Handler delegation</a></li>
<li><a href="#modular-components">Modular components</a></li>
<li><a href="#launching-the-server">Launching the server</a></li>
</ul>
</li>
<li><a href="#handler-types">Handler types</a>
<ul class="sectlevel2">
<li><a href="#asynchronous">Asynchronous</a></li>
<li><a href="#websockets">WebSockets</a></li>
<li><a href="#sse-server-sent-events">SSE (Server-Sent Events)</a></li>
<li><a href="#ring-compatibility-layer">Ring (Compatibility layer)</a></li>
<li><a href="#cps-continuation-passing-style">CPS (Continuation-passing style)</a></li>
</ul>
</li>
<li><a href="#built-in-handlers">Built-in Handlers</a>
<ul class="sectlevel2">
<li><a href="#body-parsing">Body parsing</a></li>
<li><a href="#autoreload">Autoreload</a></li>
<li><a href="#sessions">Sessions</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#security">Security</a></li>
<li><a href="#postal">Postal</a></li>
<li><a href="#request-logging">Request logging</a></li>
<li><a href="#instrumentation">Instrumentation</a></li>
</ul>
</li>
<li><a href="#plugins">Plugins</a>
<ul class="sectlevel2">
<li><a href="#catacumba-prone">catacumba-prone</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a>
<ul class="sectlevel2">
<li><a href="#website-example">Website and Auth</a></li>
<li><a href="#websocket-echo-example">WebSocket Echo</a></li>
<li><a href="#sse-component-example">Multiuser chat with SSE</a></li>
<li><a href="#prone-example">Debugging with prone</a></li>
<li><a href="#instrumentation-2">Instrumentation</a></li>
<li><a href="#single-file-example">Single file web app</a></li>
</ul>
</li>
<li><a href="#faq">FAQ</a>
<ul class="sectlevel2">
<li><a href="#difference-with-aleph">What is the difference between <em>catacumba</em> and Aleph?</a></li>
<li><a href="#rationale">What is the rationale behind this project?</a></li>
</ul>
</li>
<li><a href="#developers-guide">Developers Guide</a>
<ul class="sectlevel2">
<li><a href="#philosophy">Philosophy</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#source-code">Source Code</a></li>
<li><a href="#run-tests">Run tests</a></li>
<li><a href="#license">License</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Catacumba</em> is an asynchronous or non-blocking web toolkit for Clojure built on top
of ratpack and netty drawing inspiration from ring, pedestal and ratpack.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Project Maturity</strong>:<br>
Since <em>catacumba</em> is a young project there may be some API breakage.<br></p>
</div>
<div class="paragraph">
<p><strong>Rationale</strong>:<br>
You can read the rationale behind this project <a href="#rationale">here</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickstart"><a class="link" href="#quickstart">Quick Start</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends to explain how to get <em>catacumba</em> up and running.</p>
</div>
<div class="sect2">
<h3 id="install"><a class="link" href="#install">Install</a></h3>
<div class="paragraph">
<p>The simplest way to use <em>catacumba</em> in a clojure project is by including it in the
dependency vector on your <strong><em>project.clj</em></strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[</span><span class="tok-nv">funcool/catacumba</span> <span class="tok-s">&quot;0.17.0&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>Catacumba</em> will only run with <strong>JDK8</strong> and <strong>Clojure &gt;= 1.7</strong>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="handlers"><a class="link" href="#handlers">Handlers</a></h3>
<div class="paragraph">
<p>The handler consists of a function that accepts a "context" as it&#8217;s first parameter
and returns something renderable. Let&#8217;s see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">example-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks very similar to ring hand with two main differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>instead of request ir receives a <strong>context</strong> that works like request but with
more responsibilities (explained in other sections).</p>
</li>
<li>
<p>returns a string instead of a hash-map (it is also allowed but is not mandatory,
also explained later).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="quick-start-routing"><a class="link" href="#quick-start-routing">Routing</a></h3>
<div class="paragraph">
<p>Now knowing how we can define handlers, the next step is define a route (http
endpoint) for our handler. That can be done with <code>routes</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">ct</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:all</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-nv">example-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foobar&quot;</span> <span class="tok-nv">example-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>routes</code> function receives a vector of ordered entry points for our handlers,
and in this example we have defined two routes for the same handler (just for
demonstration purposes):</p>
</div>
<div class="paragraph">
<p>The first entry defines a <code>/</code> route for all kind of requests and the second entry
defines a <code>/foobar</code> route only for <code>GET</code> requests for the same handler.</p>
</div>
<div class="paragraph">
<p>You can read a complete documentation about catacumba&#8217;s routing <a href="#routing">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="run-the-server"><a class="link" href="#run-the-server">Run the server</a></h3>
<div class="paragraph">
<p>For run the previously defined handler, just use the <code>run-server</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-nv">app</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">3030</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>run-server</code> function doesn&#8217;t block so you can execute it in a repl without problems.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can read more about all available options that you can pass to <code>run-server</code>
function <a href="#launching-the-server">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="put-all-together"><a class="link" href="#put-all-together">Put all together</a></h3>
<div class="paragraph">
<p>This is what the complete source code of the example looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">ns </span><span class="tok-nv">exampleapp.core</span>
  <span class="tok-p">(</span><span class="tok-ss">:require</span> <span class="tok-p">[</span><span class="tok-nv">catacumba.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">ct</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-ss">:gen-class</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">example-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:all</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-nv">example-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foobar&quot;</span> <span class="tok-nv">example-handler</span><span class="tok-p">]]))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">-main</span>
  <span class="tok-p">[</span><span class="tok-o">&amp;</span> <span class="tok-nv">args</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-nv">app</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">3030</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Catacumba</em> also comes with a little collection of <a href="#examples">Examples</a> that may
help you setup your first project.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-guide"><a class="link" href="#user-guide">User Guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends explain all the different parts of <em>catacumba</em> and how they work
together.</p>
</div>
<div class="sect2">
<h3 id="handlers-2"><a class="link" href="#handlers-2">Handlers</a></h3>
<div class="paragraph">
<p>Is the fundamental building block in the <em>catacumba</em> toolkit and has two main types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ending</strong>: Handlers that process a request and return a response (usually named
controller in other web frameworks or toolkits).</p>
</li>
<li>
<p><strong>Middle</strong>: Handlers that does some logic but does not return any response (
delegating that task to other handler) (usually named as middleware or decorator).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The both handler types are defined in term of functions and looks identically, the
principal change is the responsibility. Let see an example:</p>
</div>
<div class="listingblock">
<div class="title">An <strong>ending</strong> handler example.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">sample-ending-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">An <strong>middle</strong> handler example.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">sample-middle-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nb">println </span><span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/delegate</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="the-ending-handlers"><a class="link" href="#the-ending-handlers">The ending handlers</a></h4>
<div class="paragraph">
<p>As you have seen, the examples until now are always returning a simple string that
in fact is not very useful in real-world use cases. The great news here is that
return values are handled using open polymorphic abstractions that clojure offers:
protocols.</p>
</div>
<div class="paragraph">
<p>This means that you can return anything that catacumbla already has implementation
for it or anything that yourself have implemented. Let see some examples:</p>
</div>
<div class="listingblock">
<div class="title">Handler example that returns ring style response.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">some-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">200</span>
   <span class="tok-ss">:headers</span> <span class="tok-p">{}</span>
   <span class="tok-ss">:body</span> <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Handler example that returns catacumba&#8217;s builtin response type.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.http</span> <span class="tok-ss">:as</span> <span class="tok-nv">http</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">some-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But this is not the end, if you want to know all the different kind of handlers
and its return types, please take a look on <a href="#handler-types">Handler types</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-middle-handlers"><a class="link" href="#the-middle-handlers">The middle handlers</a></h4>
<div class="paragraph">
<p>The catacumba toolkit in request/response handling perspective behaves like a
pipeline of handlers (when only one handler is attached it will be a pipeline of
one unique element).</p>
</div>
<div class="paragraph">
<p>As you have observed in the previous example, the <strong>middle</strong> handler instead of
returning a response, returns a result an opaque type that indicates to catacumba
that this handler is not of <strong>ending</strong> type and forces to catacumba take the next
handler from the pipeline and execute it. And so until <strong>ending</strong> handler is found
and response is returned.</p>
</div>
<div class="paragraph">
<p>There are nothing especial, the opaque object that <code>delegate</code> function returns
just implement appropriate protocol and if you don&#8217;t like the default behavior,
you are free to implement your own.</p>
</div>
<div class="paragraph">
<p>This is a little introduction to the delegation process and how the <strong>middle</strong>
handlers participates on it. For in depth understanding and how you can use it
in your application, please read the <a href="#handler-delegation">handler delegation</a>
section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="context"><a class="link" href="#context">Context</a></h3>
<div class="paragraph">
<p>The second thing most important in the catacumba is the <strong>context</strong>. It can
be considered a central part of both: IO and the control flow (will be
explained in advanced section).</p>
</div>
<div class="paragraph">
<p>In other words it can be considered as a combination of request and response.</p>
</div>
<div class="sect3">
<h4 id="response"><a class="link" href="#response">Response</a></h4>
<div class="paragraph">
<p>In the previous examples, we&#8217;ve seen how the return value is handled, but behind
the scenes the context is responsible for interacting with both the request and
response.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see the same example but interacting directly with the context using low-level
mutable api:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">myhandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/set-status!</span> <span class="tok-nv">context</span> <span class="tok-mi">200</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/set-headers!</span> <span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/send!</span> <span class="tok-nv">context</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value handler is really just a helper for people coming from ring.
Internally, the context is the main player in IO operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="request"><a class="link" href="#request">Request</a></h4>
<div class="paragraph">
<p>The most important thing here is that the context in a user end acts like a request
object and allows access to the most used part of the request such as the <code>:body</code>,
<code>:method</code>, <code>:query</code>, <code>:path</code>, <code>:headers</code> and <code>:cookies</code>. All them are accessible
with keyword lookups:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">request</span><span class="tok-p">)</span>
<span class="tok-c1">;; =&gt; &lt;TypedData&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TypedData</code> is a ratpack
<a href="http://ratpack.io/manual/current/api/ratpack/http/TypedData.html">internal type</a>
that represents the http request body.</p>
</div>
<div class="paragraph">
<p>That object exposes through Java interop methods to access the content type and the
raw data of the request body. For convenience, it implements the <code>clojure.java.io</code>
protocols for make it compatible with Clojure&#8217;s native facilities for reading data.</p>
</div>
<div class="paragraph">
<p>A good demonstration of this is using the clojure <code>slurp</code> function. It uses
<code>clojure.java.io</code> abstractions behind the scenes and serves as helper for reading a
resource as a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">myechohandler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-o">^</span><span class="tok-nv">String</span> <span class="tok-nv">body</span> <span class="tok-p">(</span><span class="tok-nb">slurp </span><span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">context</span><span class="tok-p">))]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">body</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>slurp</code> function uses the abstractions defined on the <code>clojure.java.io</code> namespace
for read the content of the provided resource as string and return it.</p>
</div>
<div class="paragraph">
<p>Furthermore, <em>catacumba</em> offers a more flexible way to parsing body data based on the
incoming content type, but it is explained with more details in the
<a href="#body-parsing">body parsing section</a> of this document.</p>
</div>
<div class="paragraph">
<p>Like the http request body, the http headers are available through the <code>:headers</code> key
entry. In order to extract some header, just perform the appropriate lookup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">get-in</span> <span class="tok-nv">context</span> <span class="tok-p">[</span><span class="tok-ss">:headers</span> <span class="tok-ss">:origin</span><span class="tok-p">])</span>
<span class="tok-c1">;; =&gt; &quot;https://github.com&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a header has multiple values, the value will be a vector.</p>
</div>
<div class="paragraph">
<p>Here a complete reference of the available attributes of the context object:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:body</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ratpack.io/manual/current/api/ratpack/http/TypedData.html"><code>TypedData</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A object that represents a request body.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:method</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Keyword</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A request method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:head</code>, <code>:trace</code>, <code>:get</code>, <code>:options</code>, <code>:put</code>, <code>:post</code>, <code>:patch</code> and <code>:delete</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A raw string representation of the uri querystring.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"foo=bar&amp;baz=1"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A raw string representation of the uri path.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/auth/client</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:headers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PersistentMap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A optionally multi value hash map of the request headers.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:host "funcool.org" :pragma "no-cache" &#8230;&#8203;}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:cookies</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PersistentMap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A optionally multivalue hash map of request cookies (explained in details in its own section).</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:query-params</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PersistentMap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A optionally multivalue hash map of the parsed <code>:query</code> string.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{:foo "bar" :bar 1}</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>context</code> also contains other keys but them will explain in its corresponding section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cookies"><a class="link" href="#cookies">Cookies</a></h3>
<div class="paragraph">
<p>The cookies CRUD operations works very similar to the headers one. You can access
to the request cookies through direct keyword lookup on context object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">get-in</span> <span class="tok-nv">context</span> <span class="tok-p">[</span><span class="tok-ss">:cookies</span> <span class="tok-ss">:somecookie</span><span class="tok-p">])</span>
<span class="tok-c1">;; =&gt; {:value &quot;foo&quot; :path &quot;/&quot; ...}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The cookies map is almost identical to the one that you can find in ring, and has
the following possible properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:domain</code> - restrict the cookie to a specific domain</p>
</li>
<li>
<p><code>:path</code> - restrict the cookie to a specific path</p>
</li>
<li>
<p><code>:secure</code> - restrict the cookie to HTTPS URLs if true</p>
</li>
<li>
<p><code>:http-only</code> - restrict the cookie to HTTP if true
(not accessible via e.g. JavaScript)</p>
</li>
<li>
<p><code>:max-age</code> - the number of seconds until the cookie expires</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For set cookies, you should use the <code>set-cookies!</code> function as you can see in the
following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/set-cookies!</span> <span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:cookiename</span> <span class="tok-p">{</span><span class="tok-ss">:value</span> <span class="tok-s">&quot;foobar&quot;</span> <span class="tok-ss">:max-age</span> <span class="tok-mi">3600</span><span class="tok-p">}})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Take care that the cookie value is restricted to a very limited set of characters as
spcified in <a href="https://tools.ietf.org/html/rfc6265">RFC6265</a> that netty/ratpack
implements. There also a relevant <a href="http://stackoverflow.com/a/1969339/1022392">SO answer</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="routing"><a class="link" href="#routing">Routing</a></h3>
<div class="paragraph">
<p>In contrast to ring, <em>catacumba</em> is a toolkit for web development and offers builtin
support for advanced routing that allows handlers chaining, partitioning, error
handling, among other features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>Catacumba</em> has a polymorphic and extensible way to setup handlers, and
routing is one of multiple possible implementations. Is completely optional and you
can use any other routing library if you want.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="basic-syntax"><a class="link" href="#basic-syntax">Basic syntax</a></h4>
<div class="paragraph">
<p>The routes in <em>catacumba</em> are defined using clojure data structures: vectors and
keywords. Let&#8217;s see a little example of the aspect in a complete example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The order of statements is very important because the routing in <em>catacumba</em> is a
simple chain or pipeline. Each handler has the ability to delegate the request
handling to the next handler in the pipeline.</p>
</div>
<div class="paragraph">
<p>This is a complete list of route directives that you can use a part of <code>:get</code>:
<code>:any</code> (matches all routes, often used for add chain handlers), <code>:post</code>, <code>:put</code>,
<code>:patch</code> and <code>:delete</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="dispatch-by-method"><a class="link" href="#dispatch-by-method">Dispatch by method</a></h4>
<div class="paragraph">
<p>In some circumstances you may want have different handlers depending on the HTTP
method used for one concrete endpoint. You can do it in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api/users&quot;</span>
             <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">list-users-handler</span><span class="tok-p">]</span>
             <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-nv">create-users-handler</span><span class="tok-p">]]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This also can be done in this an other way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;api/users&quot;</span> <span class="tok-nv">list-users-handler</span><span class="tok-p">]</span>
            <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-s">&quot;api/users&quot;</span> <span class="tok-nv">create-users-handler</span><span class="tok-p">]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But is considered not idiomatic and the first example should be considered
the right way to do it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Before, there was an other way to setup by method using the <code>:by-method</code>
routing directive. It is now deprecated and will be removed in the next
versions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="routing-params"><a class="link" href="#routing-params">Routing params</a></h4>
<div class="paragraph">
<p><em>catacumba</em>'s routing also allows to capture URL values encoded in the URL or as URL
parameters using special symbols. For example, the path string "foo/:val" will
match paths such as "foo/bar", "foo/123".  The matched parameters are automatically
populated to the context under the <code>:route-params</code> key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">article-detail</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">id</span> <span class="tok-p">(</span><span class="tok-nf">get-in</span> <span class="tok-nv">context</span> <span class="tok-p">[</span><span class="tok-ss">:route-params</span> <span class="tok-ss">:id</span><span class="tok-p">])]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-s">&quot;You have requested article with id=&quot;</span> <span class="tok-nv">id</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;articles/:id&quot;</span> <span class="tok-nv">article-detail</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally to the basic token for representing URL parameters, <em>catacumba</em> also
allows the use of regular expressions for delimiting the input or marking a URL
token optional.</p>
</div>
<div class="paragraph">
<p>See the following table for all supported URL tokens:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Supported url matching tokens</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path Type</th>
<th class="tableblock halign-left valign-top">Syntax</th>
<th class="tableblock halign-left valign-top">Route example</th>
<th class="tableblock halign-left valign-top">Matching url example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>foo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mandatory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:param" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»?</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:param?" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo</code> and <code>/foo/bar</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mandatory &amp; Regex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»:«regex»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:id:\d+" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional &amp; Regex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>:«token-name»?:«regex»</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[:get "foo/:id?:\d+" handler]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/foo/2</code> and <code>/foo</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="routing-chain"><a class="link" href="#routing-chain">Routing chain</a></h4>
<div class="paragraph">
<p>The chaining of handlers can be done in two different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>inline</strong>: providing more that one handler for concrete http method.</p>
</li>
<li>
<p><strong>multiple routes</strong>: providing a "match all" handler at the start of prefix.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Chaining handlers inline follows this pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">permission-check-handler</span> <span class="tok-nv">get-users-handler</span><span class="tok-p">]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you can setup "match all" handlers at the start of a routing
definition and use them as interceptors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">authentication-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a better understanding of how the handler delegation chain works, see the
<strong>Handlers delegation</strong> section in advanced guide chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="error-handling"><a class="link" href="#error-handling">Error handling</a></h4>
<div class="paragraph">
<p>The <em>catacumba</em> router chain allows to setup user defined error handling functions.
This requires a very simple setup, you only have to add another route entry with
using <code>:error</code> route directive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the previous code we have set up a global error handler, applying to all
routes in the chain. But there is also the possibility to set different error
handlers for different prefixes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">routes</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler-for-this-prefix</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">authentication-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">users-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:put</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">check-permissions-handler</span> <span class="tok-nv">update-users-hander</span><span class="tok-p">]]</span>
              <span class="tok-p">[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;admin&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:error</span> <span class="tok-nv">my-error-handler-for-this-other-prefix</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;dashboard&quot;</span> <span class="tok-nv">my-dashboard-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The error handler signature is very similar to standard HTTP handler signature,
with the difference being that it receives the throwable instance as an additional
parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-error-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">error</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/internal-server-error</span> <span class="tok-p">(</span><span class="tok-nf">.getMessage</span> <span class="tok-nv">error</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="serving-static-files"><a class="link" href="#serving-static-files">Serving static files</a></h4>
<div class="paragraph">
<p><em>Catacumba</em> also comes with the ability to serve static files. This is can be done
using <code>:assets</code> routing directive. Here an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:assets</span> <span class="tok-s">&quot;assets&quot;</span> <span class="tok-p">{</span><span class="tok-ss">:dir</span> <span class="tok-s">&quot;public/assets&quot;</span><span class="tok-p">}]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, it has support for specify a index file, that will be returned if no
file is requested. This is very useful for SPA (single page applications):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:assets</span> <span class="tok-s">&quot;assets&quot;</span> <span class="tok-p">{</span><span class="tok-ss">:dir</span> <span class="tok-s">&quot;public/assets&quot;</span>
                               <span class="tok-ss">:indexes</span> <span class="tok-p">[</span><span class="tok-s">&quot;index.html&quot;</span><span class="tok-p">]}]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, if you make a http request to <code>/assets/</code> the <code>index.html</code> will be automatically
returned.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
the assets are resolved using the <code>:basedir</code> parameter of the server
constructor; for more details see the <a href="#launching-the-server">Launching the server</a>
section.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-topics"><a class="link" href="#advanced-topics">Advanced topics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="handler-delegation"><a class="link" href="#handler-delegation">Handler delegation</a></h3>
<div class="paragraph">
<p>A part of the obvious (and previously explained) responsibility of the <code>context</code>
object in catacubla, it has some others responsibilities. Here just a summary of
them:</p>
</div>
<div class="paragraph">
<p>Here a small summary of the context responsibilities besides the obvious one
explained in previous sections (IO handling):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide direct access to the request and response objects.</p>
</li>
<li>
<p>Access to the contextual objects (called registry).</p>
</li>
<li>
<p>Flow control in handler chaining.</p>
</li>
<li>
<p>Convenience helpers for common handlers operation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In a catacumba design (inherited from ratpack), a handler is a unit of work in
an asynchronous handler pipeline and the context is a execution controller and
local storage for the current request state.</p>
</div>
<div class="paragraph">
<p>In other words it can be explained as "flow control" in the chain of handlers.</p>
</div>
<div class="paragraph">
<p>The request process is an asynchronous pipeline of handlers that can be
composed in different ways (as we previously seen in other parts of the
documentation). So the each handler in the pipeline has the ability to do some
work and delegate the rest of processing to next handler in the chain.</p>
</div>
<div class="paragraph">
<p>This approach allows you build different kind of modular and completely decoupled
handlers and compose them into a pipeline to work together.</p>
</div>
<div class="paragraph">
<p>The delegation response can be done with <code>delegate</code> function. Let see a simple
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler1</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/delegate</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler2</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">router</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">handler1</span> <span class="tok-nv">handler2</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, when the request arrives at <code>handler1</code>, it delegates the execution
to the next handler in the chain. It do not need to know about next handler, it
just delegates to the routing chain to find a next handler or raise a corresponding
error.</p>
</div>
<div class="paragraph">
<p>In addition to the simple handler delegation, <em>catacumba</em> offers a simple way to pass
context data to the next handler in the chain. It can be done by passing an
additional parameter to the <code>delegate</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler1</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">do-something</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/delegate</span> <span class="tok-p">{</span><span class="tok-ss">:message</span> <span class="tok-s">&quot;foobar&quot;</span><span class="tok-p">}))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">handler2</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">message</span> <span class="tok-p">(</span><span class="tok-ss">:message</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">message</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the second handler prints the message found in the context.</p>
</div>
</div>
<div class="sect2">
<h3 id="modular-components"><a class="link" href="#modular-components">Modular components</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> is build from its ground with optional support for the
<code>stuartsierra/component</code> library, and exposes a <code>catacumba-server</code> component with
an API for adding routes and handlers from other components.</p>
</div>
<div class="paragraph">
<p>Let see a little example on how it can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">ns </span><span class="tok-nv">yourapp.system</span>
  <span class="tok-p">(</span><span class="tok-ss">:require</span> <span class="tok-p">[</span><span class="tok-nv">com.stuartsierra.component</span> <span class="tok-ss">:as</span> <span class="tok-nv">component</span><span class="tok-p">]</span>
            <span class="tok-p">[</span><span class="tok-nv">catacumba.components</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">catacumba-server</span> <span class="tok-nv">assoc-routes!</span><span class="tok-p">)]))</span>

<span class="tok-c1">;; Define your web application component, it will be responsible to setup</span>
<span class="tok-c1">;; the routes to the catacumba-server component of your handlers</span>

<span class="tok-p">(</span><span class="tok-kd">defrecord </span><span class="tok-nv">WebApp</span> <span class="tok-p">[</span><span class="tok-nv">server</span><span class="tok-p">]</span>
  <span class="tok-nv">component/Lifecycle</span>
  <span class="tok-p">(</span><span class="tok-nf">start</span> <span class="tok-p">[</span><span class="tok-nv">this</span><span class="tok-p">]</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-handler</span><span class="tok-p">]</span>
                  <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;bar&quot;</span> <span class="tok-nv">other-handler</span><span class="tok-p">]]]</span>
      <span class="tok-p">(</span><span class="tok-nf">assoc-routes!</span> <span class="tok-nv">server</span> <span class="tok-ss">::web</span> <span class="tok-nv">routes</span><span class="tok-p">)))</span>

  <span class="tok-p">(</span><span class="tok-nf">stop</span> <span class="tok-p">[</span><span class="tok-nv">this</span><span class="tok-p">]</span>
    <span class="tok-c1">;; noop</span>
    <span class="tok-p">))</span>

<span class="tok-c1">;; Define a simple constructor for your web application component</span>
<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">webapp</span> <span class="tok-p">[]</span>
  <span class="tok-p">(</span><span class="tok-nf">-&gt;WebApp</span> <span class="tok-nv">nil</span><span class="tok-p">))</span>

<span class="tok-c1">;; Define the system with two main components: catacumba-server and webapp</span>
<span class="tok-c1">;; and explicitly specify the dependency of catacumba-server for webapp/</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">application-system</span>
  <span class="tok-s">&quot;The application system constructor.&quot;</span>
  <span class="tok-p">[]</span>
  <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">component/system-map</span>
       <span class="tok-ss">:catacumba</span> <span class="tok-p">(</span><span class="tok-nf">catacumba-server</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">5050</span><span class="tok-p">})</span>
       <span class="tok-ss">:app</span> <span class="tok-p">(</span><span class="tok-nf">webapp</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">component/system-using</span>
       <span class="tok-p">{</span><span class="tok-ss">:app</span> <span class="tok-p">{</span><span class="tok-ss">:server</span> <span class="tok-ss">:catacumba</span><span class="tok-p">}})))</span>

<span class="tok-c1">;; Just define an entry point for the application.</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">-main</span>
  <span class="tok-s">&quot;The main entry point to your application.&quot;</span>
  <span class="tok-p">[</span><span class="tok-o">&amp;</span> <span class="tok-nv">args</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">component/start</span> <span class="tok-p">(</span><span class="tok-nf">application-system</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Be aware that each call to the <code>assoc-routes!</code> function will cause the server
to reload. In the majority of circumstances this is completely irrelevant
because it is done at application bootstrap time.</p>
</div>
<div class="paragraph">
<p>To understand it better, <em>catacumba</em> comes with an <a href="#sse-component-example">example</a>
that builds a multiuser chat using "Server-Sent events" and component, so you can
experiment with real code. See the <a href="#examples">examples</a> section for it.</p>
</div>
</div>
<div class="sect2">
<h3 id="launching-the-server"><a class="link" href="#launching-the-server">Launching the server</a></h3>
<div class="sect3">
<h4 id="getting-started"><a class="link" href="#getting-started">Getting Started</a></h4>
<div class="paragraph">
<p>As you can see in the quick start section, the main entry point for start the
server is the <code>run-server</code> function that receives a handler chain and a map
with options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">ct</span><span class="tok-p">])</span>

<span class="tok-c1">;; handler definition goes here</span>

<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-o">#</span><span class="tok-ss">&#39;my-handler</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">4040</span> <span class="tok-ss">:debug</span> <span class="tok-nv">true</span><span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-options"><a class="link" href="#configuration-options">Configuration Options</a></h4>
<div class="paragraph">
<p>Here a complete reference of the currently supported options that can be passed
to the <code>run-server</code> function:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Keyword</th>
<th class="tableblock halign-center valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:port</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>5050</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port to listen on.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:threads</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">(num of cores * 2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of threads for handler requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:debug</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start in development mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:setup</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>nil</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A callback for configuration step (low level ratpack access).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:basedir</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>nil</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application base directory, used mainly for resolving relative paths and assets.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:keystore-path</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>nil</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A relative path in the classpath to the ssl keystore.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:keystore-secret</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>nil</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A secret for the ssl key store</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:decorators</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>nil</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A vector of handlers to attach at the start of the pipeline</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:marker-file</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>.catacumba.basedir</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A file name that will be used to find the base directory in the class path.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>:max-body-size</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1048576 bytes (1mb)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A maximum length of body.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All supported options of this function, can be overwritten at JVM startup, using
environment variables or system properties. This allows to customize the
server without modifying source code and exists for convenience to make easy
customizations in deployments.</p>
</div>
<div class="paragraph">
<p>For example, you can change the default port on JVM startup using the
<code>CATACUMBA_PORT</code> environment variable or <code>catacumba.port</code> system property:</p>
</div>
<div class="listingblock">
<div class="title">Example using enviroment variables</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nb">export </span><span class="tok-nv">CATACUMBA_PORT</span><span class="tok-o">=</span>8000
<span class="tok-nb">export </span><span class="tok-nv">CATACUMBA_BASEDIR</span><span class="tok-o">=</span><span class="tok-sb">`</span><span class="tok-nb">pwd</span><span class="tok-sb">`</span>
java -jar yourjarhere.jar</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example using enviroment variables</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">java -Dcatacumba.port<span class="tok-o">=</span><span class="tok-m">8000</span> -Dcatacumba.debug<span class="tok-o">=</span><span class="tok-nb">true</span> -jar yourjarhere.jar</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If no <code>:basedir</code> is specified, catacumba will try to find a <code>.catacumba.basedir</code>
file in the classpath and will set a base dir to its  directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you are deploying your application as uberjar and you want serve static files
from the classpath, you should set the <code>:marker-file</code> to somethig different that
the default value (e.g. <code>catacumba.basedir</code>) without the first <code>.</code>, because
leiningen ignores all files that starts with dot.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ssl-configuration"><a class="link" href="#ssl-configuration">SSL Configuration</a></h4>
<div class="paragraph">
<p><em>Catacumba</em> server can be configured to use TLS (commonly known as SSL). The process
is pretty simple but it requires to have a proper key and certificate.</p>
</div>
<div class="paragraph">
<p>The first thing that you should care about is that <em>catacumba</em> is built on jvm
that the default ssl certificate/key format used by nginx/apache it isn&#8217;t compatible
but is very easy create a compatible file using the <code>openssl</code> command line.</p>
</div>
<div class="paragraph">
<p>Having a key and the certificate, just execute this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">openssl pkcs12 -export -in cert.pem -inkey key.pem -out store.p12</code></pre>
</div>
</div>
<div class="paragraph">
<p>This process will ask you for a password that you must memorize and later
provide it to catacumba. Now, having the properly formated trusted store,
just pass some additional parameters on starting the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-o">#</span><span class="tok-ss">&#39;my-handler</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">4040</span>
                             <span class="tok-ss">:keystore-secret</span> <span class="tok-s">&quot;yoursecrethere&quot;</span>
                             <span class="tok-ss">:keystore-path</span> <span class="tok-s">&quot;path/to/store.p12&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>catacumba</em> at this moment does not has the "upgrade" approach so if
you setup ssl, only ssl connections will be accepted. So the most recommended
way to use ssl on your application is put catacumba behind nginx or haproxy
and make them handle the ssl.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handler-types"><a class="link" href="#handler-types">Handler types</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section intends to explain the different kind of built in handler types and the
response types that comes out of the box with catacumba. This section is organized
on handler types as first level and possible supported return values as second
level.</p>
</div>
<div class="sect2">
<h3 id="asynchronous"><a class="link" href="#asynchronous">Asynchronous</a></h3>
<div class="paragraph">
<p>Asynchronous handlers are handlers that return a value in an asynchronous way using
one of the supported abstractions, such as core.async, reactive-streams and many
others (explained below).</p>
</div>
<div class="sect3">
<h4 id="channel-core-async"><a class="link" href="#channel-core-async">Channel (core.async)</a></h4>
<div class="paragraph">
<p>The <code>core.async</code> channel is one of the supported abstractions that comes with
<em>catacumba</em> out of the box. It consists of a handler that returns a body as a
channel or response as a channel.</p>
</div>
<div class="paragraph">
<p>This is the aspect of async handler returning a core.async channel as a body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">ch</span> <span class="tok-p">(</span><span class="tok-nf">chan</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">go</span>
      <span class="tok-p">(</span><span class="tok-nb">dotimes </span><span class="tok-p">[</span><span class="tok-nv">i</span> <span class="tok-mi">10</span><span class="tok-p">]</span>
        <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">500</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">ch</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-nv">i</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">ch</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">ch</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not worry about how much data you can send to the client, if you are using
channels in a right way (in a go block), you will send data to the client as fast
as the client can consume it. This technique is also called back pressure, and is
fully supported for chunked responses.</p>
</div>
<div class="paragraph">
<p>Additionally, you also can return a channel as the handler response. The main
difference is that in this case you should put a complete response into the channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">go</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">result</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">do-some-async-task</span><span class="tok-p">))]</span>
      <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">(</span><span class="tok-ss">:data</span> <span class="tok-nv">result</span><span class="tok-p">)))))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="completablefuture"><a class="link" href="#completablefuture">CompletableFuture</a></h4>
<div class="paragraph">
<p>Sometimes, you do not need send a chunked stream to the client, but your "business
logic" is defined in an asynchronous friendly API using promises (or something
similar). In this case, with <em>catacumba</em> you can return a promise as a body or as a
response and the data will be sent to the client when the promise has been resolved
successfully.</p>
</div>
<div class="paragraph">
<p>The <code>CompletableFuture</code> is an other asynchronous primitive supported out of the box
by <em>catacumba</em>; so you can return it as body or as response.</p>
</div>
<div class="paragraph">
<p>For more pleasant usage of <code>CompletableFuture</code> in clojure, the
<a href="https://github.com/funcool/promesa">promesa library</a> is used. That library
provides a more clojure friendly api on top of JDK8 <code>CompletableFuture</code> and a great
sugar syntax for composing them thanks to the
<a href="https://github.com/funcool/cats">cats library</a>.</p>
</div>
<div class="listingblock">
<div class="title">A example using the <em>promesa</em> library api for create a <code>CompletableFuture</code> instance and return it as body.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">promesa.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">promise</span> <span class="tok-p">(</span><span class="tok-nf">p/promise</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">promise</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Like as usual, you can return an instance of <code>CompletableFuture</code> as response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">promesa.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">p/promise</span> <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">resolve</span><span class="tok-p">]</span>
               <span class="tok-p">(</span><span class="tok-nf">future</span>
                 <span class="tok-p">(</span><span class="tok-nf">Thread/sleep</span> <span class="tok-mi">100</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nb">resolve </span><span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">))))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the advantages of using <code>CompletableFuture</code> abstraction with <em>promesa</em> and
<em>cats</em> libraries is that them both exposes additional sugar syntax that work with
promises in a more painless way.</p>
</div>
<div class="paragraph">
<p>Let see an example that takes the <a href="https://github.com/funcool/cats">cats</a>
<code>mlet</code> macro, composes few async computations in a very clojure familiar syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">promesa.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">p</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cats.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">m</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">m/mlet</span> <span class="tok-p">[</span><span class="tok-nv">tempvar</span> <span class="tok-p">(</span><span class="tok-nf">something-that-returns-promise</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
           <span class="tok-nv">result</span> <span class="tok-p">(</span><span class="tok-nf">do-something-with</span> <span class="tok-nv">a</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">result</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of <code>mlet</code> macro expression will be an instance of <code>CompletableFuture</code> that
eventually will be completed with the http response.</p>
</div>
</div>
<div class="sect3">
<h4 id="manifold-deferred"><a class="link" href="#manifold-deferred">Manifold Deferred</a></h4>
<div class="paragraph">
<p>The <a href="https://github.com/ztellman/manifold">manifold</a> library also offers a promise
like abstraction. The main advantage of using it is that is build for clojure and
is not restricted to JDK8.</p>
</div>
<div class="listingblock">
<div class="title">Example code that returns a body as manifold deferred.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">manifold.deferred</span> <span class="tok-ss">:as</span> <span class="tok-nv">d</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">result</span> <span class="tok-p">(</span><span class="tok-nf">d/future</span>
                 <span class="tok-p">(</span><span class="tok-nf">Thread/sleep</span> <span class="tok-mi">1000</span><span class="tok-p">)</span>
                 <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">result</span> <span class="tok-p">{</span><span class="tok-s">&quot;content-type&quot;</span> <span class="tok-s">&quot;text/plain&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Like the previously explained abstractions, you also can return manifold deferreds
as handler response.</p>
</div>
</div>
<div class="sect3">
<h4 id="manifold-streams"><a class="link" href="#manifold-streams">Manifold Streams</a></h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="reactive-streams"><a class="link" href="#reactive-streams">Reactive-Streams</a></h4>
<div class="paragraph">
<p>The <a href="http://www.reactive-streams.org/">reactive-streams</a> support is inherited from
ratpack and like manifold streams it is only can be used for send the response body.</p>
</div>
<div class="paragraph">
<p>Here there isn&#8217;t anything  new to explain, just build and/or compose your streams
and return them as http response body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.stream</span> <span class="tok-ss">:as</span> <span class="tok-nv">stream</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cuerdas.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">str</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-async-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">pub</span> <span class="tok-p">(</span><span class="tok-nf">-&gt;&gt;</span> <span class="tok-p">(</span><span class="tok-nf">stream/publisher</span> <span class="tok-p">[</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot; &quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">])</span>
                 <span class="tok-p">(</span><span class="tok-nf">stream/transform</span> <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-nv">str/upper</span><span class="tok-p">)))]</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-nv">pub</span><span class="tok-p">)))</span>

<span class="tok-c1">;; It will return a chunked response to the client with &quot;HELLO WORLD&quot; string.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the best parts of the reactive-strams is that them comes with back pressure
support out of the box and it native support in ratpack makes them a great glue
abstraction for similar async primitives. In fact, the support for all stream like
primitives explained until now are implemented in terms of <em>reactive-streams</em>
publisher.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="websockets"><a class="link" href="#websockets">WebSockets</a></h3>
<div class="paragraph">
<p>One of the main goals of <em>catacumba</em> is come with builtin, full featured and
back pressure aware websockets support.</p>
</div>
<div class="paragraph">
<p>You can start a websocket connection in any <em>catacumba</em> handler or route handler
using <code>websocket</code> function. It does not require any special handlers for dealing
with websockets. Let see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-websocket-echo-handler</span>
  <span class="tok-p">[{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">in</span> <span class="tok-nv">out</span><span class="tok-p">]}]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">received</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-nv">in</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nf">do</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-nv">received</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/websocket</span> <span class="tok-nv">context</span> <span class="tok-nv">my-websocket-echo-handler</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">my-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, <em>catacumba</em> offers a way to set up a websocket handler directly,
without an additional step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">echo-handler</span>
  <span class="tok-s">&quot;This is my echo handler that serves as</span>
<span class="tok-s">  a websocket handler example.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/websocket</span><span class="tok-p">}</span>
  <span class="tok-p">[{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">in</span> <span class="tok-nv">out</span><span class="tok-p">]}]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">if-let </span><span class="tok-p">[</span><span class="tok-nv">received</span> <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-nv">in</span><span class="tok-p">)]</span>
      <span class="tok-p">(</span><span class="tok-nf">do</span>
        <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-nv">received</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">close!</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-o">#</span><span class="tok-ss">&#39;echo-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can observe, the var metadata is used for properly choice the right adapter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Is very important pass a var reference to the router instead of the function
directly, because the metadata defined in the function is bound to the var and not
to the function.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, you can attach metadata inline, using the <code>with-meta</code> Clojure built-in
function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
             <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nb">with-meta </span><span class="tok-nv">echo-handler</span>
                     <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/websocket</span><span class="tok-p">})]]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Clojure offers a lot of flexibility for working with metadata so you can set the
handler type in the way that you prefer.</p>
</div>
</div>
<div class="sect2">
<h3 id="sse-server-sent-events"><a class="link" href="#sse-server-sent-events">SSE (Server-Sent Events)</a></h3>
<div class="paragraph">
<p>WebSockets are cool because they allow bi-directional communication, but in some
circumstances we only need something unidirectional, for notifying the client about
some changes or any other events. For this purpose exists
<a href="https://developer.mozilla.org/en-US/docs/Server-sent_events">Server-Sent Events</a>
(SSE) and <em>catacumba</em> also has support for it.</p>
</div>
<div class="paragraph">
<p>The handler for SSE does not differs much from websockets (that we have seen in the
previous section). The main difference is that server-sent events are unidirectional
and they only can send data in the server to client direction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">time-notification</span>
  <span class="tok-s">&quot;Handler that notifies each second</span>
<span class="tok-s">  the current server time to the client.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/sse</span><span class="tok-p">}</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">out</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
    <span class="tok-p">(</span><span class="tok-nb">when-let </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-p">(</span><span class="tok-nf">java.time.Instant/now</span><span class="tok-p">)))]</span>
      <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">1000</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-o">#</span><span class="tok-ss">&#39;time-notification</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar way to websockets, you can start SSE in any place, such as a standard
<em>catacumba</em> handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">time-notification</span>
  <span class="tok-s">&quot;Handler that notifies each second</span>
<span class="tok-s">  the current server time to the client.&quot;</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/sse</span> <span class="tok-nv">context</span>
          <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">out</span><span class="tok-p">]</span>
            <span class="tok-p">(</span><span class="tok-nf">go-loop</span> <span class="tok-p">[]</span>
              <span class="tok-p">(</span><span class="tok-nb">when-let </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">(</span><span class="tok-nb">str </span><span class="tok-p">(</span><span class="tok-nf">java.time.Instant/now</span><span class="tok-p">)))]</span>
                <span class="tok-p">(</span><span class="tok-nf">&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">timeout</span> <span class="tok-mi">1000</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))))))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">route</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;events&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">time-notification</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let see some examples how you can send other parameters than simple data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-c1">;; Send data</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-s">&quot;data as string&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:data</span> <span class="tok-s">&quot;data as string&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; Send data with event name</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:data</span> <span class="tok-s">&quot;data as string&quot;</span> <span class="tok-ss">:event</span> <span class="tok-s">&quot;foobar&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; Set id</span>
<span class="tok-p">(</span><span class="tok-nf">&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">{</span><span class="tok-ss">:id</span> <span class="tok-s">&quot;2&quot;</span><span class="tok-p">})</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <em>catacumba</em>'s SSE support uses core.async channels, but if you are not
happy with core.async and want use something different (such as manifold streams),
you may want know that everything in <em>catacumba</em> is implemented using abstractions
and to implement your own SSE type of handler that uses manifold streams is very
easy.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ring-compatibility-layer"><a class="link" href="#ring-compatibility-layer">Ring (Compatibility layer)</a></h3>
<div class="paragraph">
<p>Although ring support is not first citizen in <em>catacumba</em>, the current design of
it allows to create an handler adapter that follows the ring specification. This
is a great example of extensibility of <em>catacumba</em>.</p>
</div>
<div class="paragraph">
<p>Let see how it can be done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">myringhandler</span>
  <span class="tok-s">&quot;My example ring handler.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/ring</span><span class="tok-p">}</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">200</span>
   <span class="tok-ss">:body</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; As standalone handler</span>
<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-o">#</span><span class="tok-ss">&#39;myringhandler</span><span class="tok-p">)</span>

<span class="tok-c1">;; Or in a _catacumba_ routing chain</span>
<span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:get</span> <span class="tok-o">#</span><span class="tok-ss">&#39;myringhandler</span><span class="tok-p">]])</span>
    <span class="tok-p">(</span><span class="tok-nf">ct/run-server</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ring handlers can be set as standalone handlers (mainly for using them with
compojure and all related middlewares) or in a <em>catacumba</em>'s routing chain.</p>
</div>
</div>
<div class="sect2">
<h3 id="cps-continuation-passing-style"><a class="link" href="#cps-continuation-passing-style">CPS (Continuation-passing style)</a></h3>
<div class="paragraph">
<p>Is a low level handler type that works in a cps style (in other words, they works
with callbacks). This is not general purpose handler type but you maybe found it
useful for integrate catacumba with other scenarios that it is not initially
designed to work.</p>
</div>
<div class="paragraph">
<p>This is the aspect ot the cps style handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-cps-handler</span>
  <span class="tok-s">&quot;Some usefull docstring.&quot;</span>
  <span class="tok-p">{</span><span class="tok-ss">:handler-type</span> <span class="tok-ss">:catacumba/cps</span><span class="tok-p">}</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">callback</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">future</span>
    <span class="tok-p">(</span><span class="tok-nf">Thread/sleep</span> <span class="tok-mi">1000</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">callback</span> <span class="tok-s">&quot;hello world&quot;</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="built-in-handlers"><a class="link" href="#built-in-handlers">Built-in Handlers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will cover different kind of built-in additional handlers to make the
experience of using <em>catacumba</em> more pleasant.</p>
</div>
<div class="sect2">
<h3 id="body-parsing"><a class="link" href="#body-parsing">Body parsing</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> comes with builtin support for conditional body parsing depending on the
incoming content type. It consists of a routing chain that adds the <code>:data</code> entry in
the context with the parsed data or <code>nil</code> in case of an incoming content type does
not have an attached parser implementation.</p>
</div>
<div class="paragraph">
<p>In order to use it you should prepending the <code>body-params</code> handler to your route
chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.parse</span> <span class="tok-ss">:as</span> <span class="tok-nv">parse</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">example-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">body</span> <span class="tok-p">(</span><span class="tok-ss">:data</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nb">println </span><span class="tok-s">&quot;Received data:&quot;</span> <span class="tok-nv">body</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">http/no-content</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">parse/body-params</span><span class="tok-p">)]</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">example-handler</span><span class="tok-p">]]))</span>

<span class="tok-c1">;; ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>,
<code>application/json</code>, <code>application/transit+json</code> and <code>application/transit+msgpack</code>
parsers come out of the box. The <a href="https://github.com/dakrone/cheshire">cheshire</a>
json parser is used for parsing the body with the <code>application/json</code> content type.</p>
</div>
<div class="paragraph">
<p>The body parsing is a open system, implemented using clojure&#8217;s polymorphism facilities
such as multimethods. If you want add additional parser, just add an additional
implementation to the parse multimethod with your content-type as dispatch tag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.parse</span> <span class="tok-ss">:as</span> <span class="tok-nv">parse</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nb">import </span><span class="tok-ss">&#39;ratpack.http.TypedData</span>
        <span class="tok-ss">&#39;ratpack.handling.Context</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-kd">defmethod </span><span class="tok-nv">parse/parse-body</span> <span class="tok-ss">:application/xml</span>
  <span class="tok-p">[</span><span class="tok-o">^</span><span class="tok-nv">Context</span> <span class="tok-nv">ctx</span> <span class="tok-o">^</span><span class="tok-nv">TypedData</span> <span class="tok-nv">body</span><span class="tok-p">]</span>
  <span class="tok-c1">;; your parsing logic here</span>
  <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="autoreload"><a class="link" href="#autoreload">Autoreload</a></h3>
<div class="paragraph">
<p>The autoreload handler consist in a very simple concept: reload all modified
namespaces on each request. If you are familiar with the ring reload middleware,
this one works in almost identical way.</p>
</div>
<div class="paragraph">
<p>For use it, just attach it to your routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.misc</span> <span class="tok-ss">:as</span> <span class="tok-nv">misc</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">misc/autoreloader</span><span class="tok-p">)]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-o">#</span><span class="tok-ss">&#39;somens/your-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;bar&quot;</span> <span class="tok-o">#</span><span class="tok-ss">&#39;somens/other-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-nv">...</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see a working example in the <a href="#website-example">Website example</a> code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The auto-reloading can only work if you pass var references to the router
definition instead resolved values. In same way as the previous example.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sessions"><a class="link" href="#sessions">Sessions</a></h3>
<div class="sect3">
<h4 id="getting-started-2"><a class="link" href="#getting-started-2">Getting Started</a></h4>
<div class="paragraph">
<p>The HTTP sessions in <em>catacumba</em> are also implemented as chain handler. So you can
add session handling support to you application just by adding the handler to your
routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.session</span> <span class="tok-ss">:as</span> <span class="tok-nv">session</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">session/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All handlers in the route pipeline that are going after the session handler will come
with <code>:session</code> key in the context with a "atom" like object. You just treat it
as atom, so for attaching some data to the session you should use the well
known <code>swap!</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">session</span> <span class="tok-p">(</span><span class="tok-ss">:session</span> <span class="tok-nv">context</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">swap!</span> <span class="tok-nv">session</span> <span class="tok-nb">assoc </span><span class="tok-ss">:userid</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-s">&quot;my response&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can clean the session just reseting to the empty map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">reset!</span> <span class="tok-nv">session</span> <span class="tok-p">{})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the big advantages of using the routing chain for session set up, is that
you can restrict session handling to a concrete subset of urls/resources avoiding
unnecessary code execution for handlers that do not need sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;admin&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">session/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]</span>
              <span class="tok-p">[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;users&quot;</span> <span class="tok-nv">other-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">...</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="session-storages"><a class="link" href="#session-storages">Session storages</a></h4>
<div class="paragraph">
<p>Currently <em>catacumba</em> comes with one basic session storage, the <code>:inmemory</code>. But the
session storage system is pluggable and is defined in terms of the following
protocol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defprotocol </span><span class="tok-nv">ISessionStorage</span>
  <span class="tok-p">(</span><span class="tok-nf">read-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">key</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">write-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nb">key </span><span class="tok-nv">data</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">delete-session</span> <span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-nv">key</span><span class="tok-p">]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are familiar with the ring based session storages, you can observe that the
<em>catacumba</em> session storage abstraction is almost identical to the ring session
abstraction, so migrating from or adapting the ring session storages is really
easy. The unique difference is that functions should return a promise (from
promesa library).</p>
</div>
<div class="paragraph">
<p>To use a concrete session storage, just pass a instance of it as value of
the <code>:storage</code> key in a session handler constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">session/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-p">(</span><span class="tok-nf">my-storage-constructor</span><span class="tok-p">)})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want implement own session storage, take a look to the <code>:inmemory</code> builtin
one.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authentication"><a class="link" href="#authentication">Authentication</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> also comes with authentication facilities heavily inspired by
<strong>buddy-auth</strong>.</p>
</div>
<div class="paragraph">
<p>We do not have used directly <strong>buddy-auth</strong> because it is designed for ring based
applications, therefore the buddy-auth abstractions are blocking, and blocking api
is not well suited for async based applications.</p>
</div>
<div class="paragraph">
<p>So, <em>catacumba</em> defines own abstractions for handle authentication, that are very
very similar to the <em>buddy-auth</em>, with the exception that them expose asynchronous
api, so adapt existing <em>buddy-auth</em> backends should be very easy.</p>
</div>
<div class="paragraph">
<p>Like <strong>buddy-auth</strong>, <em>catacumba</em> comes with a little set of builtin backends that can
be used directly: <strong>session</strong>, <strong>jws</strong> (token) and <strong>jwe</strong> (encrypted token).</p>
</div>
<div class="sect3">
<h4 id="session"><a class="link" href="#session">Session</a></h4>
<div class="paragraph">
<p>Let start with session authentication backend. This backend is mainly used for web
based applications and consists in verify some value on the session. So this is the
easiest authentication scheme and fits perfectly for the first contact.</p>
</div>
<div class="paragraph">
<p>Start importing some needed namespaces and create an instance
of the authentication backend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.http</span> <span class="tok-ss">:as</span> <span class="tok-nv">http</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.auth</span> <span class="tok-ss">:as</span> <span class="tok-nv">cauth</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">auth-backend</span>
  <span class="tok-p">(</span><span class="tok-nf">cauth/session-backend</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, continue defining a handler for the login action. It consists in receive
credentials from the user input and verify them. In case of success verification,
we just need setup the <code>:identity</code> key in the session.</p>
</div>
<div class="paragraph">
<p>Let see a partially implemented example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">login-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">data</span> <span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">find-user</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">data</span><span class="tok-p">)</span>   <span class="tok-c1">;; (implementation omitted)</span>
                        <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">data</span><span class="tok-p">))]</span>
    <span class="tok-p">(</span><span class="tok-nf">swap!</span> <span class="tok-p">(</span><span class="tok-ss">:session</span> <span class="tok-nv">context</span><span class="tok-p">)</span> <span class="tok-nb">assoc </span><span class="tok-ss">:identity</span> <span class="tok-nv">user</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-s">&quot;ok&quot;</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to start using auth facilities in your application, you should add the
authentication handler to the routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-c1">;; The application routes definition with session, auth and body</span>
<span class="tok-c1">;; parsing chain handlers</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">session/session</span> <span class="tok-p">{</span><span class="tok-ss">:storage</span> <span class="tok-ss">:inmemory</span><span class="tok-p">})]</span> <span class="tok-c1">;; Http Session</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">cauth/auth</span> <span class="tok-nv">auth-backend</span><span class="tok-p">)]</span>              <span class="tok-c1">;; Auth backend</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">parse/body-params</span><span class="tok-p">)]</span>                  <span class="tok-c1">;; Body parsing</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;login&quot;</span> <span class="tok-nv">login-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">some-handler</span><span class="tok-p">]]))</span>                     <span class="tok-c1">;; (implementation omitted)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see a working example using auth facilities <a href="#website-example">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="jws-token"><a class="link" href="#jws-token">JWS Token</a></h4>
<div class="paragraph">
<p>This authentication backend consists in use self contained tokens for authenticate
the user. It behaves very similar to the session one but instead of strong the user
information in a server storage, it stores it directly in a token, enabling so,
completely stateless authentication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The security and the implementation of cryptographic primitives for that
token is relied to the <strong>buddy-sign</strong> library (an other module of buddy) that
implements the JWS specification. That library should be used for generate JWS
tokens.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let start creating a backend instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">secret</span> <span class="tok-s">&quot;mysecret&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">auth-backend</span>
  <span class="tok-p">(</span><span class="tok-nf">cauth/jws-backend</span> <span class="tok-p">{</span><span class="tok-ss">:secret</span> <span class="tok-nv">secret</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Following of our new login handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jws</span> <span class="tok-ss">:as</span> <span class="tok-nv">jws</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cheshire.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">json</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">login-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">data</span> <span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">find-user</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">data</span><span class="tok-p">)</span>   <span class="tok-c1">;; (implementation omitted)</span>
                        <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">data</span><span class="tok-p">))]</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-p">{</span><span class="tok-ss">:token</span> <span class="tok-p">(</span><span class="tok-nf">jws/sign</span> <span class="tok-p">{</span><span class="tok-ss">:user</span> <span class="tok-p">(</span><span class="tok-ss">:id</span> <span class="tok-nv">user</span><span class="tok-p">)}</span> <span class="tok-nv">secret</span><span class="tok-p">)})</span>
        <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;application/json&quot;</span><span class="tok-p">}))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, put the new backend into the routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">cauth/auth</span> <span class="tok-nv">auth-backend</span><span class="tok-p">)]</span>     <span class="tok-c1">;; Auth backend</span>
              <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">parse/body-params</span><span class="tok-p">)]</span>           <span class="tok-c1">;; Body parsing</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;login&quot;</span> <span class="tok-nv">login-handler</span><span class="tok-p">]</span>
              <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">some-handler</span><span class="tok-p">]]))</span>               <span class="tok-c1">;; (implementation omitted)</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Take care that using jws for create tokens, the data is serialized using
json + base64 and signed using strong cryptography signatures. That method ensure that
the data can not be manipulated by third party but it not protect it from privacy. If
you need store private data in the token, consider using JWE.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jwe-token"><a class="link" href="#jwe-token">JWE Token</a></h4>
<div class="paragraph">
<p>This authentication backend consists in using self contained tokens for
authenticate the user. It works identically to the JWS (explained previously) with
the exception that instead of only signing data, it also encrypts the data, so
ensuring the data privacy.</p>
</div>
<div class="paragraph">
<p>You can create the backend instance so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jwe</span> <span class="tok-ss">:as</span> <span class="tok-nv">jwe</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.core.keys</span> <span class="tok-ss">:as</span> <span class="tok-nv">keys</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">pubkey</span> <span class="tok-p">(</span><span class="tok-nf">keys/public-key</span> <span class="tok-s">&quot;pubkey.pem&quot;</span><span class="tok-p">))</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">privkey</span> <span class="tok-p">(</span><span class="tok-nf">keys/private-key</span> <span class="tok-s">&quot;privkey.pem&quot;</span> <span class="tok-s">&quot;thekeysecret&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">auth-backend</span>
  <span class="tok-p">(</span><span class="tok-nf">auth/jwe-backend</span> <span class="tok-nv">privkey</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In this example we use asymmetric encryption scheme, if you want use an other
encryption scheme, please check
<a href="https://funcool.github.io/buddy-sign/latest/#_json_web_encryption">buddy-sign documentation</a>
for the complete list of supported encryption algorithms.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The login handler is almost identical:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jws</span> <span class="tok-ss">:as</span> <span class="tok-nv">jws</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cheshire.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">json</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">login-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">data</span> <span class="tok-p">(</span><span class="tok-ss">:body</span> <span class="tok-nv">context</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">find-user</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">data</span><span class="tok-p">)</span>   <span class="tok-c1">;; (implementation ommited)</span>
                        <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">data</span><span class="tok-p">))]</span>
    <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-p">{</span><span class="tok-ss">:token</span> <span class="tok-p">(</span><span class="tok-nf">jwe/encrypt</span> <span class="tok-p">{</span><span class="tok-ss">:user</span> <span class="tok-p">(</span><span class="tok-ss">:id</span> <span class="tok-nv">user</span><span class="tok-p">)}</span> <span class="tok-nv">pubkey</span><span class="tok-p">)})</span>
        <span class="tok-p">(</span><span class="tok-nf">http/ok</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;application/json&quot;</span><span class="tok-p">}))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of signing the content, we encrypt it using the public key. The routing
chain is completely identical from the JWE Token examples.</p>
</div>
</div>
<div class="sect3">
<h4 id="other"><a class="link" href="#other">Other</a></h4>
<div class="paragraph">
<p>If you not happy with the builtin auth facilities, the <em>catacumba</em>'s handler system
is very flexible and you really don&#8217;t need to use <em>buddy</em>. You can write your own
auth facilities and attach them to <em>catacumba</em> using the routing chain.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security"><a class="link" href="#security">Security</a></h3>
<div class="sect3">
<h4 id="cross-origin-resource-sharing"><a class="link" href="#cross-origin-resource-sharing">Cross-Origin Resource Sharing</a></h4>
<div class="paragraph">
<p>Cross-Origin Resource Sharing (CORS) is a mechanism that allows restricted
resources (e.g. fonts, JavaScript, etc.) on a web page to be requested from another
domain outside the domain from which the resource originated.</p>
</div>
<div class="paragraph">
<p>Is often used for allowing API resources to be accessed in a web browser, out of the
domain of your web applications.</p>
</div>
<div class="paragraph">
<p><em>Catacumba</em> has builtin support for CORS, and this is how you can use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.misc</span> <span class="tok-ss">:as</span> <span class="tok-nv">misc</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">cors-conf</span> <span class="tok-p">{</span><span class="tok-ss">:origin</span> <span class="tok-o">#</span><span class="tok-p">{</span><span class="tok-s">&quot;http://website.com&quot;</span><span class="tok-p">}</span>                     <span class="tok-c1">;; mandatory</span>
                <span class="tok-ss">:max-age</span> <span class="tok-mi">3600</span>                                       <span class="tok-c1">;; optional</span>
                <span class="tok-ss">:allow-methods</span> <span class="tok-o">#</span><span class="tok-p">{</span><span class="tok-ss">:post</span> <span class="tok-ss">:put</span> <span class="tok-ss">:get</span> <span class="tok-ss">:delete</span><span class="tok-p">}</span>           <span class="tok-c1">;; optional</span>
                <span class="tok-ss">:allow-headers</span> <span class="tok-o">#</span><span class="tok-p">{</span><span class="tok-ss">:x-requested-with</span> <span class="tok-ss">:content-type</span><span class="tok-p">}})</span> <span class="tok-c1">;; optional</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;api/v1&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">misc/cors</span> <span class="tok-nv">cors-conf</span><span class="tok-p">)]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-handler</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:post</span> <span class="tok-s">&quot;foo&quot;</span> <span class="tok-nv">some-save-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:origin</code> key can be a set of possible origins or simply <code>"*"</code> to allow all
origins.</p>
</div>
</div>
<div class="sect3">
<h4 id="content-security-policy"><a class="link" href="#content-security-policy">Content Security Policy</a></h4>
<div class="paragraph">
<p>Is a security related chain handler that appropriately sets the
<code>Content-Security-Policy</code> headers.</p>
</div>
<div class="paragraph">
<p>Content Security Policy (CSP) is an added layer of security that helps to detect and
mitigate certain types of attacks, including Cross Site Scripting (XSS) and data
injection attacks. These attacks are used for everything from data theft to site
defacement or distribution of malware.</p>
</div>
<div class="paragraph">
<p>Here a simple example on how to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">cspconf</span> <span class="tok-p">{</span><span class="tok-ss">:default-src</span> <span class="tok-s">&quot;&#39;self&#39; *.trusted.com&quot;</span>
              <span class="tok-ss">:img-src</span> <span class="tok-s">&quot;*&quot;</span>
              <span class="tok-ss">:frame-ancestors</span> <span class="tok-s">&quot;&#39;none&#39;&quot;</span>
              <span class="tok-ss">:reflected-xss</span> <span class="tok-s">&quot;filter&quot;</span><span class="tok-p">})</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">csp-headers</span> <span class="tok-nv">cspconf</span><span class="tok-p">)]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can read more about that here:
<a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/CSP</a>. The complete list of
directives can be found here:
<a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives</a></p>
</div>
<div class="paragraph">
<p>This handler supports the following directives: <code>:default-src</code>, <code>:frame-ancestors</code>,
<code>:frame-src</code>, <code>:child-src</code>, <code>:connect-src</code>, <code>:font-src</code>, <code>:form-action</code>, <code>:img-src</code>,
<code>:media-src</code>,  <code>:object-src</code>, and <code>:reflected-xss</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="frame-options"><a class="link" href="#frame-options">Frame Options</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds <code>X-Frame-Options</code> header to the
response.</p>
</div>
<div class="paragraph">
<p>The X-Frame-Options HTTP response header can be used to indicate whether or not a
browser should be allowed to render a page in a <code>&lt;frame&gt;</code>, <code>&lt;iframe&gt;</code> or
<code>&lt;object&gt;</code> . Sites can use this to avoid clickjacking attacks, by ensuring that
their content is not embedded into other sites.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.security</span> <span class="tok-ss">:as</span> <span class="tok-nv">sec</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">sec/frame-options-headers</span> <span class="tok-p">{</span><span class="tok-ss">:policy</span> <span class="tok-ss">:deny</span><span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The possible values for the <code>:policy</code> key are: <code>:deny</code> and <code>:sameorigin</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The frame-ancestors directive from the CSP Level 2 specification officially
replaces this non-standard header.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strict-transport-security"><a class="link" href="#strict-transport-security">Strict Transport Security</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds the <code>Strict-Transport-Security</code>
header to the response.</p>
</div>
<div class="paragraph">
<p>HTTP Strict Transport Security (often abbreviated as HSTS) is a security feature that
lets a web site tell browsers that it should only be communicated with using HTTPS,
instead of using HTTP.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.security</span> <span class="tok-ss">:as</span> <span class="tok-nv">sec</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">sec/hsts-headers</span> <span class="tok-p">{</span><span class="tok-ss">:max-age</span> <span class="tok-mi">31536000</span> <span class="tok-ss">:subdomains</span> <span class="tok-nv">true</span> <span class="tok-p">})]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can read more about that header here:
<a href="https://developer.mozilla.org/en-US/docs/Web/Security/HTTP_strict_transport_security" class="bare">https://developer.mozilla.org/en-US/docs/Web/Security/HTTP_strict_transport_security</a></p>
</div>
</div>
<div class="sect3">
<h4 id="content-type-options"><a class="link" href="#content-type-options">Content Type Options</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that adds the <code>X-Content-Type-Options</code>
header to the response. It prevents resources with invalid media types being loaded
as stylesheets or scripts.</p>
</div>
<div class="paragraph">
<p>This chain handler does not have any additional parameters. Let see an example on
how you can use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.security</span> <span class="tok-ss">:as</span> <span class="tok-nv">sec</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-nv">sec/content-type-options-headers</span><span class="tok-p">]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx" class="bare">http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/List_of_useful_HTTP_headers" class="bare">https://www.owasp.org/index.php/List_of_useful_HTTP_headers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="csrf-cross-site-request-forgery"><a class="link" href="#csrf-cross-site-request-forgery">CSRF (Cross-Site Request Forgery)</a></h4>
<div class="paragraph">
<p>This is a security related chain handler that protects the following handlers from
one-click attack.</p>
</div>
<div class="paragraph">
<p>For use it, just add it to your routing pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.security</span> <span class="tok-ss">:as</span> <span class="tok-nv">sec</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:prefix</span> <span class="tok-s">&quot;web&quot;</span>
               <span class="tok-p">[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">sec/csrf-protect</span><span class="tok-p">)]</span>
               <span class="tok-p">[</span><span class="tok-ss">:get</span> <span class="tok-nv">your-handler</span><span class="tok-p">]]]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The response will be populated automatically with <code>csrftoken</code> cookie that
should be read by the client side javascript and put the same value under
the <code>x-csrftoken</code> header or under <code>csrftoken</code> form encoded field.</p>
</div>
<div class="paragraph">
<p>If you want access to the current value of the csrftoken inside catacumba
handler, you can do it using <code>:catacumba.handlers.security</code> keyword lookup
on the context.</p>
</div>
<div class="paragraph">
<p>More information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" class="bare">https://en.wikipedia.org/wiki/Cross-site_request_forgery</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF" class="bare">https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF</a>)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="postal"><a class="link" href="#postal">Postal</a></h3>
<div class="paragraph">
<p>The typical web application usually follows the api REST architecture, but the main
problem of that is that is bound directly to the HTTP semantics that are not
always coherent or not always clear how to use.</p>
</div>
<div class="paragraph">
<p>This is a backend side implementation
<a href="https://funcool.github.io/catacumba/latest/postal.html">postal protocol</a>,
that allows expose rich apis based on the user needs on top of http/websockets.</p>
</div>
<div class="paragraph">
<p>The general idea behind the protocol and this library is borrowed from
<a href="https://facebook.github.io/relay/">Facebook Relay</a> and
<a href="http://netflix.github.io/falcor/">Netflix&#8217;s Falcor</a>.
The main differents with them is that this library only represents the transport and
message routing layer layer, so it&#8217;s is nonobstructive and not coupled with
concrete framework and persistence.</p>
</div>
<div class="paragraph">
<p>One of the great examples where this library fits in a perfection is a
transport and message routing layer for
<a href="https://github.com/omcljs/om/wiki/Quick-Start-(om.next)">Om.Next</a>
but it not tied by it.</p>
</div>
<div class="sect3">
<h4 id="getting-started-3"><a class="link" href="#getting-started-3">Getting Started</a></h4>
<div class="paragraph">
<p>The <strong>postal</strong> handler looks like a default <em>catacumba</em> handler with one extra
argument: frame. The frame is a structured message received from the client that
has this aspect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">{</span><span class="tok-ss">:type</span> <span class="tok-ss">:query</span>
 <span class="tok-ss">:dest</span> <span class="tok-ss">:users</span>
 <span class="tok-ss">:data</span> <span class="tok-p">{</span><span class="tok-ss">:id</span> <span class="tok-mi">1</span><span class="tok-p">}}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>:type</code> and <code>:dest</code> keys are mandatory to be present in the frame.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The messages are by default serialized using transit+json serialization format
but the system is open to be extended with other formats. The serialization is
completely transparent to the user, the catacumba will do all the hard work for
you.</p>
</div>
<div class="paragraph">
<p>Knowing the frame structure, the best way to define a postal handler is using
multimethods, because they allow easy dispatch by value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.postal</span> <span class="tok-ss">:as</span> <span class="tok-nv">pc</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defmulti </span><span class="tok-nv">myhandler</span>
  <span class="tok-p">(</span><span class="tok-nb">comp </span><span class="tok-p">(</span><span class="tok-nf">juxt</span> <span class="tok-ss">:type</span> <span class="tok-ss">:dest</span><span class="tok-p">)</span> <span class="tok-nb">second </span><span class="tok-nv">vector</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defmethod </span><span class="tok-nv">myhandler</span> <span class="tok-p">[</span><span class="tok-ss">:query</span> <span class="tok-ss">:users</span><span class="tok-p">]</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-p">{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">data</span><span class="tok-p">]</span> <span class="tok-ss">:as</span> <span class="tok-nv">frame</span><span class="tok-p">}]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">id</span> <span class="tok-p">(</span><span class="tok-ss">:id</span> <span class="tok-nv">data</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">repo/get-user-by-id</span> <span class="tok-nv">id</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">pc/frame</span> <span class="tok-nv">user</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-kd">defmethod </span><span class="tok-nv">myhandler</span> <span class="tok-p">[</span><span class="tok-ss">:novelty</span> <span class="tok-ss">:users</span><span class="tok-p">]</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">frame</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">status</span> <span class="tok-p">(</span><span class="tok-nf">create-new-user</span> <span class="tok-nv">frame</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">pc/frame</span> <span class="tok-nv">user</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>message</code> function is just a helper for create response hashmaps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">pc/frame</span> <span class="tok-p">{</span><span class="tok-ss">:foo</span> <span class="tok-mi">1</span><span class="tok-p">})</span>
<span class="tok-c1">;; =&gt; {:type :response :data {:foo 1}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to plain return values, you can freely return a promise or deferred
(from <strong>promesa</strong> and <strong>manifold</strong> libraries respectively). And if that abstractions
do not satisfies you, the system is completely open to be extended with your
own abstractions.</p>
</div>
<div class="paragraph">
<p>And finally, attach the handler on the router:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-s">&quot;api&quot;</span> <span class="tok-p">(</span><span class="tok-nf">pc/router</span> <span class="tok-nv">myhandler</span><span class="tok-p">)]]))</span>

<span class="tok-p">(</span><span class="tok-nf">ct/run-server</span> <span class="tok-o">#</span><span class="tok-ss">&#39;app</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="server-push"><a class="link" href="#server-push">Server Push</a></h4>
<div class="paragraph">
<p>Additionally to the traditional rpc, it also offers a server-push or/and
bi-directional communication with server.</p>
</div>
<div class="paragraph">
<p>This is the aspect of the handler that starts the bi-directional communication
with the client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">clojure.core.async</span> <span class="tok-ss">:as</span> <span class="tok-nv">a</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">now</span>
  <span class="tok-p">[]</span>
  <span class="tok-p">(</span><span class="tok-nf">System/currentTimeMillis</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-kd">defmethod </span><span class="tok-nv">myhandler</span> <span class="tok-p">[</span><span class="tok-ss">:subscribe</span> <span class="tok-ss">:timeupdate</span><span class="tok-p">]</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span> <span class="tok-nv">frame</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nf">letfn</span> <span class="tok-p">[(</span><span class="tok-nf">on-connect</span> <span class="tok-p">[{</span><span class="tok-ss">:keys</span> <span class="tok-p">[</span><span class="tok-nv">in</span> <span class="tok-nv">out</span><span class="tok-p">]</span> <span class="tok-ss">:as</span> <span class="tok-nv">context</span><span class="tok-p">}]</span>
            <span class="tok-p">(</span><span class="tok-nf">a/go-loop</span> <span class="tok-p">[]</span>
              <span class="tok-p">(</span><span class="tok-nb">when-let </span><span class="tok-p">[</span><span class="tok-nv">_</span> <span class="tok-p">(</span><span class="tok-nf">a/&gt;!</span> <span class="tok-nv">out</span> <span class="tok-p">(</span><span class="tok-nf">pc/frame</span> <span class="tok-ss">:message</span> <span class="tok-p">{</span><span class="tok-ss">:time</span> <span class="tok-p">(</span><span class="tok-nf">now</span><span class="tok-p">)}))]</span>
                <span class="tok-p">(</span><span class="tok-nf">a/&lt;!</span> <span class="tok-p">(</span><span class="tok-nf">a/timeout</span> <span class="tok-mi">100</span><span class="tok-p">))</span>
                 <span class="tok-p">(</span><span class="tok-nf">recur</span><span class="tok-p">))))]</span>
    <span class="tok-p">(</span><span class="tok-nf">pc/socket</span> <span class="tok-nv">context</span> <span class="tok-nv">on-connect</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes, the <code>socket</code> function just upgrades to websockets and uses
it as low-level transport layer for message communication between the client and
the server.</p>
</div>
<div class="paragraph">
<p>Additionally, behind the scenes, catacumba sends a ping frames to the client for
keep alive the connection. This is happens every 5 seconds. At this moment
this value it is not configurable but it will change in a future.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This documentation will explain only the backend related stuff. For client usage,
please refer to the <a href="https://github.com/funcool/postal">client documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="request-logging"><a class="link" href="#request-logging">Request logging</a></h3>
<div class="paragraph">
<p><strong>catacumba</strong> by default does not logs almost anything in console, and the request
logging is not an exception. This is a good default and is very recommended use
reverse proxy logging facilities.</p>
</div>
<div class="paragraph">
<p>But, if you want request logging in <strong>catacumba</strong>, you can easy activate it just
attaching additional handler to your routing chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">catacumba.handlers.misc</span> <span class="tok-ss">:as</span> <span class="tok-nv">misc</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">misc/log</span><span class="tok-p">)]</span>
              <span class="tok-c1">;; here your handlers</span>
              <span class="tok-p">]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default implementation in most cases is more than enough, but if you don&#8217;t happy
with it you can provide your own function for logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-logging-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">context</span>, <span class="tok-nv">outcome</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nb">println </span><span class="tok-nv">context</span> <span class="tok-nv">outcome</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">ct/routes</span> <span class="tok-p">[[</span><span class="tok-ss">:any</span> <span class="tok-p">(</span><span class="tok-nf">misc/log</span> <span class="tok-nv">my-logging-handler</span><span class="tok-p">)]</span>
              <span class="tok-c1">;; here your handlers</span>
              <span class="tok-p">]))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>context</code> parameter is just a context that you have already used previously,
and <code>outcome</code> is hash map that contains additional data such as: response headers, respose status and request duration time.</p>
</div>
</div>
<div class="sect2">
<h3 id="instrumentation"><a class="link" href="#instrumentation">Instrumentation</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="plugins"><a class="link" href="#plugins">Plugins</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will explain useful modules that are not part of the core of
<em>catacumba</em> but are fully supported.</p>
</div>
<div class="sect2">
<h3 id="catacumba-prone"><a class="link" href="#catacumba-prone">catacumba-prone</a></h3>
<div class="paragraph">
<p><a href="https://github.com/magnars/prone">Prone</a> is a exception reporting middleware for
ring based applications that show a beautiful, navigable and human readable
stacktraces when an exception is throwed in your application.</p>
</div>
<div class="paragraph">
<p>Full documentation: <a href="https://github.com/funcool/catacumba-prone" class="bare">https://github.com/funcool/catacumba-prone</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can found a <a href="#prone-example">complete example</a> using prone in the <a href="#examples">examples section</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="link" href="#examples">Examples</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="website-example"><a class="link" href="#website-example">Website and Auth</a></h3>
<div class="paragraph">
<p>This example tries to show the way to use <em>catacumba</em> in a website like projects,
with <strong>authentication</strong> and <strong>sessions</strong>.</p>
</div>
<div class="paragraph">
<p>Just run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/
<span class="tok-nv">$ </span>lein with-profile website-example run
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/website">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="websocket-echo-example"><a class="link" href="#websocket-echo-example">WebSocket Echo</a></h3>
<div class="paragraph">
<p>This example application tries to show a very simple application
using the websockets capabilities of <em>catacumba</em></p>
</div>
<div class="paragraph">
<p>Get it up and running following this commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/
<span class="tok-nv">$ </span>lein with-profile websocket-echo-example run
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/websocket-echo">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sse-component-example"><a class="link" href="#sse-component-example">Multiuser chat with SSE</a></h3>
<div class="paragraph">
<p>This example tries to demonstrate how can you build a simple chat using
"Server-Sent Events" for communicating events to the client and using
<strong>stuartsierra/component</strong> for a modular application architecture.</p>
</div>
<div class="paragraph">
<p>For make this example application run, follow this commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/
<span class="tok-nv">$ </span>lein with-profile component-chat-example run
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, open <a href="http://localhost:5050" class="bare">http://localhost:5050</a> in two different browsers and try send messages
between them.</p>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/component-chat">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="prone-example"><a class="link" href="#prone-example">Debugging with prone</a></h3>
<div class="paragraph">
<p><a href="https://github.com/magnars/prone">Prone</a> is really awesome middleware for
ring that shows a beautiful and human readable stack traces when a exception is
raised in your application.</p>
</div>
<div class="paragraph">
<p>Just follow the following commands for get it up and running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/
<span class="tok-nv">$ </span>lein with-profile debugging-example run
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/debugging">here</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Obviously, if you are using the ring type of handler, you can use Prone as is,
without any additional adaptation. This example shows how it can be used with
<em>catacumba</em>'s default handler type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="instrumentation-2"><a class="link" href="#instrumentation-2">Instrumentation</a></h3>
<div class="paragraph">
<p><em>Catacumba</em> comes with the ability to instrument your application for taking
different kinds of diagnosis, such as performance, latency, etc. This example
shows how it can be done.</p>
</div>
<div class="paragraph">
<p>In case of this concrete example application, it uses the instrumentation facilities
of catacumba for monitoring the time of execution of request handlers.</p>
</div>
<div class="paragraph">
<p>Follow this steps for get this example up and running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/
<span class="tok-nv">$ </span>lein with-profile interceptor-example run
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>And go to <a href="http://localhost:5050/" class="bare">http://localhost:5050/</a></p>
</div>
<div class="paragraph">
<p>After some requests, you will see the similar output in the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">Computation :compute elapsed in: 0.025150461 <span class="tok-o">(</span>sec<span class="tok-o">)</span>
Computation :compute elapsed in: 0.001690894 <span class="tok-o">(</span>sec<span class="tok-o">)</span>
Computation :compute elapsed in: 0.001541675 <span class="tok-o">(</span>sec<span class="tok-o">)</span>
Computation :compute elapsed in: 0.001554894 <span class="tok-o">(</span>sec<span class="tok-o">)</span>
Computation :compute elapsed in: 0.00175033 <span class="tok-o">(</span>sec<span class="tok-o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/interceptor">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="single-file-example"><a class="link" href="#single-file-example">Single file web app</a></h3>
<div class="paragraph">
<p><strong>This example application requires that you should have
<a href="http://boot-clj.com">boot-clj</a> properly installed on your system.</strong></p>
</div>
<div class="paragraph">
<p>This example tries to show how you can use <em>catacumba</em> for building small web
applications that fits in one file and execute them like a shell script or
an executable.</p>
</div>
<div class="paragraph">
<p>You should execute the following commands for get it up and running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span class="tok-nv">$ </span>git clone git@github.com:funcool/catacumba.git
<span class="tok-nv">$ </span><span class="tok-nb">cd </span>catacumba/examples/single-file
<span class="tok-nv">$ </span><span class="tok-nb">export </span><span class="tok-nv">BOOT_CLOJURE_VERSION</span><span class="tok-o">=</span>1.7.0
<span class="tok-nv">$ </span>./main.clj
<span class="tok-o">[</span>main<span class="tok-o">]</span> INFO ratpack.server.RatpackServer - Ratpack started <span class="tok-k">for</span> http://localhost:5050</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can found the source code of this example
<a href="https://github.com/funcool/catacumba/tree/master/examples/single-file">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="link" href="#faq">FAQ</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="difference-with-aleph"><a class="link" href="#difference-with-aleph">What is the difference between <em>catacumba</em> and Aleph?</a></h3>
<div class="paragraph">
<p>First of all, Aleph is not a real alternative to catacumba, because its approach is
so much low level and its web server support is a little bit constrained by ring
spec.
Furthermore, aleph is already used in catacumba as http client in tests code and
manifold (async abstractions behind aleph) is a first class abstractions
for handle async values.</p>
</div>
<div class="paragraph">
<p>So, I&#8217;m happy to tell you that you can use the both libraries together because
they are very complementary.</p>
</div>
</div>
<div class="sect2">
<h3 id="rationale"><a class="link" href="#rationale">What is the rationale behind this project?</a></h3>
<div class="paragraph">
<p>I started writing this library as a research project to provide a simple, non
obstructive (a la ring) without the constraints of the existing ring spec.
The aim is to create a web toolkit for building asynchronous web services.</p>
</div>
<div class="paragraph">
<p>Here is an incomplete list of things that <em>catacumba</em> aims to achieve:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow different types of handlers by being flexible and extensible</p>
</li>
<li>
<p>Provide a simple and lightweight approach for defining asynchronous web services
with support for different abstractions such as promises, futures, core.async,
manifold, reactive-streams, etc&#8230;&#8203;</p>
</li>
<li>
<p>Build upon abstractions with simplicity and extensibility in mind.</p>
</li>
<li>
<p>Provide built in declarative style routing.</p>
</li>
<li>
<p>Remain unopinionated and versatile.</p>
</li>
<li>
<p>Come with back pressure support out of the box.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>catacumba</em> is not designed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To be a fully integrated full stack solution like Immutant or Pedestal.</p>
</li>
<li>
<p>To provide an opinionated way to structure your "business logic"</p>
</li>
<li>
<p>To provide all possible features that you might need.</p>
</li>
<li>
<p>To be a low level, ring based library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The result of this research project is a powerful, lightweight, and fully
extensible asynchronous web toolkit built on top of existing and well designed
components such as Ratpack and Netty.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developers-guide"><a class="link" href="#developers-guide">Developers Guide</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="philosophy"><a class="link" href="#philosophy">Philosophy</a></h3>
<div class="paragraph">
<p>Five most important rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beautiful is better than ugly.</p>
</li>
<li>
<p>Explicit is better than implicit.</p>
</li>
<li>
<p>Simple is better than complex.</p>
</li>
<li>
<p>Complex is better than complicated.</p>
</li>
<li>
<p>Readability counts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All contributions to <em>catacumba</em> should keep these important rules in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="contributing"><a class="link" href="#contributing">Contributing</a></h3>
<div class="paragraph">
<p>Unlike Clojure and other Clojure contributed libraries <em>catacumba</em> does not have many
restrictions for contributions. Just open an issue or pull request.</p>
</div>
</div>
<div class="sect2">
<h3 id="source-code"><a class="link" href="#source-code">Source Code</a></h3>
<div class="paragraph">
<p><em>catacumba</em> is open source and can be found on
<a href="https://github.com/funcool/catacumba">github</a>.</p>
</div>
<div class="paragraph">
<p>You can clone the public repository with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">git clone https://github.com/funcool/catacumba</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-tests"><a class="link" href="#run-tests">Run tests</a></h3>
<div class="paragraph">
<p>For running tests just execute this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">lein test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="license"><a class="link" href="#license">License</a></h3>
<div class="paragraph">
<p><em>catacumba</em> is licensed under BSD (2-Clause) license:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Copyright (c) 2015 Andrey Antukh &lt;niwi@niwi.nz&gt;

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

* Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.17.0<br>
Last updated 2016-06-10 16:21:35 EEST
</div>
</div>
</body>
</html>